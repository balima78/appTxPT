{
    "collab_server" : "",
    "contents" : "# codificar colunas A B DR de modo a permitir calculo de cPRA e sensibilidades\ncodABDR<-function(HLA = dados){\n  Aa1 <- sub(\"^\", \"A\", HLA$A1)\n  Aa2 <- sub(\"^\", \"A\", HLA$A2)\n  Ba1 <- sub(\"^\", \"B\", HLA$B1)\n  Ba2 <- sub(\"^\", \"B\", HLA$B2)\n  DRa1 <- sub(\"^\", \"DR\", HLA$DRB11)\n  DRa2 <- sub(\"^\", \"DR\", HLA$DRB12)\n  \n  cbind(HLA, Aa1, Aa2, Ba1, Ba2, DRa1, DRa2)\n}\n\n# calcular cPRA\n\ncedace<-read.csv2(\"cedace.csv\")\n\n\n# função calcular cPRA por doente (id de icheiro de sensibilidades)\ncpra<-function(id = 30155110, donors = cedace, sensib = sAMP2017){\n  \n  donors<-codABDR(donors)\n  \n  pra_calculado<-dim(subset(donors,\n                            Aa1 %in% sensib[sensib$ID == id, \"acs\"] \n                            | Aa2 %in% sensib[sensib$ID == id, \"acs\"]\n                           | Ba1 %in% sensib[sensib$ID == id, \"acs\"]\n                            | Ba2 %in% sensib[sensib$ID == id, \"acs\"] \n                            | DRa1 %in% sensib[sensib$ID == id, \"acs\"]\n                            | DRa2 %in% sensib[sensib$ID == id, \"acs\"])\n  )[1] / dim(donors)[1]\n  pra_calculado \n}\n\n\n# função calcular cPRAs de vários doentes (versão 1)\ncprax<-function(ids=1:5, donors = dadores, sensib = s){\n  if(!require(purrr)) {\n    message(\"instaling the 'purrr' package\")\n    install.packages(\"purrr\")\n    library(purrr)\n  }\n  \n  donors<-codABDR(donors)\n  \n  p<-map_dbl((ids), function(x){\n    cpra(id=x, donors, sensib)\n  })\n  data.frame(utenteid=ids,cPRA=round(p,2))\n}\n\n\n# função calcular cPRAs de vários doentes (versão 2)\ncpras<-function(ids=1:5, donors = dadores, sensib = s){\n  \n  donors<-codABDR(donors)\n  \n  p<-NA\n  \n  for (i in 1:length(ids)) {\n    p[i]<-cpra(ids[i], donors, sensib)\n    p\n  }\n  \n  data.frame(utenteid=ids,cPRA=round(p,2))\n}\n\n\n\n\n###############################################################\n## calcular cPRA através das frequencias haplotipicas\n# anticorpos HLA-A-B-DR para 1 doente\ncpra_1<-function(id = 30155110, sensib = acHLA,\n                   A_freq = read.csv2(\"CEDACE/hla_A.csv\"),\n                 B_freq = read.csv2(\"CEDACE/hla_B.csv\"),\n                 DR_freq = read.csv2(\"CEDACE/hla_DRB1.csv\"),\n                 AB_freq = read.csv2(\"CEDACE/hla_AB.csv\"),\n                 ADR_freq = read.csv2(\"CEDACE/hla_ADR.csv\"),\n                 BDR_freq = read.csv2(\"CEDACE/hla_BDR.csv\"),\n                 ABDR_freq = read.csv2(\"CEDACE/hla_ABDR.csv\")){\n  if(!require(dplyr)) {\n    message(\"instaling the 'dplyr' package\")\n    install.packages(\"dplyr\")\n    library(dplyr)\n  }  \n\n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% A_freq$AA)>=1){\n    Sa<-sum(A_freq %>% \n              filter(AA %in% sensib[sensib$ID == id,\"acs\"]) %>% \n              select(freq))\n  } else Sa<-0\n\n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% B_freq$BB)>=1){\n  Sb<-sum(B_freq %>% \n            filter(BB %in% sensib[sensib$ID == id,\"acs\"]) %>% \n            select(freq))\n  } else Sb<-0\n  \n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% DR_freq$DDR)>=1){\n  Sdr<-sum(DR_freq %>% \n            filter(DDR %in% sensib[sensib$ID == id,\"acs\"]) %>% \n            select(freq))\n  } else Sdr<-0\n\n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% A_freq$AA &\n      sensib[sensib$ID == id,\"acs\"] %in% B_freq$BB) >=1){  \n  Sab<-sum(AB_freq %>% \n            filter(AA %in% sensib[sensib$ID == id,\"acs\"] &\n                     BB %in% sensib[sensib$ID == id,\"acs\"]) %>% \n            select(freq))\n  } else Sab<-0\n  \n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% A_freq$AA &\n      sensib[sensib$ID == id,\"acs\"] %in% DR_freq$DDR) >=1){  \n  Sadr<-sum(ADR_freq %>% \n             filter(AA %in% sensib[sensib$ID == id,\"acs\"] &\n                      DDR %in% sensib[sensib$ID == id,\"acs\"]) %>% \n             select(freq))\n  } else Sadr<-0\n  \n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% B_freq$BB &\n      sensib[sensib$ID == id,\"acs\"] %in% DR_freq$DDR) >=1){  \n  Sbdr<-sum(BDR_freq %>% \n             filter(DDR %in% sensib[sensib$ID == id,\"acs\"] &\n                      BB %in% sensib[sensib$ID == id,\"acs\"]) %>% \n             select(freq))\n  } else Sbdr<-0\n  \n  if(sum(sensib[sensib$ID == id,\"acs\"] %in% B_freq$BB &\n     sensib[sensib$ID == id,\"acs\"] %in% DR_freq$DDR &\n     sensib[sensib$ID == id,\"acs\"] %in% A_freq$AA)>=1){  \n  Sabdr<-sum(ABDR_freq %>% \n             filter(AA %in% sensib[sensib$ID == id,\"acs\"] &\n                      BB %in% sensib[sensib$ID == id,\"acs\"] &\n                      DDR %in% sensib[sensib$ID == id,\"acs\"]) %>% \n             select(freq))\n  } else Sabdr<-0\n  \n  cpraf<-1-(1-Sa-Sb-Sdr+Sab+Sbdr+Sadr-Sabdr)^2\n  cpraf\n  \n} \n\n\n### calculo de cPRA pelas frequencias alelicas e hapotipicas\ncpraf<-function(ids = acHLA$ID, sensib = acHLA,\n                  A_freq = read.csv2(\"CEDACE/hla_A.csv\"), \n                  B_freq = read.csv2(\"CEDACE/hla_B.csv\"),\n                  DR_freq = read.csv2(\"CEDACE/hla_DRB1.csv\"),\n                  AB_freq = read.csv2(\"CEDACE/hla_AB.csv\"),\n                  ADR_freq = read.csv2(\"CEDACE/hla_ADR.csv\"),\n                  BDR_freq = read.csv2(\"CEDACE/hla_BDR.csv\"),\n                  ABDR_freq = read.csv2(\"CEDACE/hla_ABDR.csv\")){\n\n  if(!require(dplyr)) {\n    message(\"instaling the 'dplyr' package\")\n    install.packages(\"dplyr\")\n    library(dplyr)\n  }  \n  \n  cpraf<-rep(NA,length(ids))\n\n  for (i in 1:length(ids)){\n    cpraf[i]<-cpra_1(id = ids[i], sensib,\n                     A_freq = read.csv2(\"CEDACE/hla_A.csv\"), \n                     B_freq = read.csv2(\"CEDACE/hla_B.csv\"),\n                     DR_freq = read.csv2(\"CEDACE/hla_DRB1.csv\"),\n                     AB_freq = read.csv2(\"CEDACE/hla_AB.csv\"),\n                     ADR_freq = read.csv2(\"CEDACE/hla_ADR.csv\"),\n                     BDR_freq = read.csv2(\"CEDACE/hla_BDR.csv\"),\n                     ABDR_freq = read.csv2(\"CEDACE/hla_ABDR.csv\"))\n  }                    \n   \n  data.frame(utenteid = ids, cpraf)                 \n}\n\n\n\n# ler tabelas com frequencias alélicas e haplotipicas\n#A_freq = read.csv2(\"CEDACE/hla_A.csv\") \n#B_freq = read.csv2(\"CEDACE/hla_B.csv\")\n#DR_freq = read.csv2(\"CEDACE/hla_DRB1.csv\")\n\n#AB_freq = read.csv2(\"CEDACE/hla_AB.csv\")\n#ADR_freq = read.csv2(\"CEDACE/hla_ADR.csv\")\n#BDR_freq = read.csv2(\"CEDACE/hla_BDR.csv\")\n\n#ABDR_freq = read.csv2(\"CEDACE/hla_ABDR.csv\")\n\n\n# criar coluna com nome de anticorpos\n#AA<- sub(\"^\", \"A\", A_freq$A)\n#A_freq<-cbind(A_freq,AA)\n#BB<- sub(\"^\", \"B\", B_freq$B)\n#B_freq<-cbind(B_freq,BB)\n#DDR<- sub(\"^\", \"DR\", DR_freq$DR)\n#DR_freq<-cbind(DR_freq,DDR)\n\n#AA<- sub(\"^\", \"A\", AB_freq$A)\n#BB<- sub(\"^\", \"B\", AB_freq$B)\n#AB_freq<-cbind(AB_freq,AA,BB)\n\n#AA<- sub(\"^\", \"A\", ADR_freq$A)\n#DDR<- sub(\"^\", \"DR\", ADR_freq$DR)\n#ADR_freq<-cbind(ADR_freq,AA,DDR)\n\n#BB<- sub(\"^\", \"B\", BDR_freq$B)\n#DDR<- sub(\"^\", \"DR\", BDR_freq$DR)\n#BDR_freq<-cbind(BDR_freq,BB,DDR)\n\n#AA<- sub(\"^\", \"A\", ABDR_freq$A)\n#BB<- sub(\"^\", \"B\", ABDR_freq$B)\n#DDR<- sub(\"^\", \"DR\", ABDR_freq$DR)\n#ABDR_freq<-cbind(ABDR_freq,AA,BB,DDR)\n\n#write.csv2(A_freq, \"CEDACE/hla_A.csv\") \n#write.csv2(B_freq, \"CEDACE/hla_B.csv\")\n#write.csv2(DR_freq, \"CEDACE/hla_DRB1.csv\")\n#write.csv2(AB_freq, \"CEDACE/hla_AB.csv\")\n#write.csv2(ADR_freq, \"CEDACE/hla_ADR.csv\")\n#write.csv2(BDR_freq, \"CEDACE/hla_BDR.csv\")\n#write.csv2(ABDR_freq, \"CEDACE/hla_ABDR.csv\")\n\n",
    "created" : 1523291659916.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "141451587",
    "id" : "7412AB60",
    "lastKnownWriteTime" : 1505070554,
    "last_content_update" : 1505070554,
    "path" : "D:/CHN/Allocation 2017-09/1_fxs_cPRA.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}